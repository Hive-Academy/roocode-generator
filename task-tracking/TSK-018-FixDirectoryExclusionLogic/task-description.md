---
title: Task Description
type: template
category: task
taskId: TSK-018
taskName: FixDirectoryExclusionLogic
priority: High
---

# Task Description: TSK-018/FixDirectoryExclusionLogic

## 1. Task Overview

This task addresses a critical issue where the `ProjectContext.structure.directoryTree` generated by `ProjectAnalyzer` incorrectly includes directories that should be excluded (e.g., `node_modules`, `dist`, `coverage`, `bin`, and hidden directories like `.vscode`). This was identified as a failure point (NEW AC3) during the verification of TSK-017 (see `task-tracking/TSK-017-FixGoogleGenAIProviderIssues/implementation-plan.md`, Line 118).

The root cause is that the `StructureHelpers.generateDirectoryTree` function does not currently apply the project-defined `SKIP_DIRECTORIES` list or the convention of skipping hidden directories (names starting with a `.`) during its recursive scan of the project structure.

Fixing this is crucial for generating an accurate and lean `ProjectContext`, which is essential for downstream processes like memory bank generation and for managing LLM token limits.

## 2. Current Implementation Analysis

- **`ProjectAnalyzer.collectAnalyzableFiles` (`src/core/analysis/project-analyzer.ts`):** This method correctly uses the `SKIP_DIRECTORIES` set (from `src/core/analysis/constants.ts`) and a check for `itemName.startsWith('.')` to filter directories when creating a _flat list_ of analyzable files for content collection and AST parsing.
- **`StructureHelpers.generateDirectoryTree` (`src/core/analysis/structure-helpers.ts`):** This function is responsible for building the nested `directoryTree`.
  - It currently filters _files_ within the tree based on the `shouldAnalyzeFile` callback.
  - It prunes directory branches that become empty after their child files/directories are filtered.
  - **Crucially, it does NOT currently check directory names against `SKIP_DIRECTORIES` or skip directories starting with `.` before deciding to recurse into them or include them in the tree.**
- **`SKIP_DIRECTORIES` Constant (`src/core/analysis/constants.ts`):** This set contains the list of directory names that should be globally excluded (e.g., `node_modules`, `dist`).
- **Observation from TSK-017:** `.git` was reported as correctly excluded from the `directoryTree`. This is likely a side effect of `shouldAnalyzeFile` filtering out all files within `.git`, leading to the `.git` node being pruned due to having no analyzable children, rather than a direct exclusion of the `.git` directory itself by `generateDirectoryTree`.

## 3. Component Structure

- **Primary file to modify:** `src/core/analysis/structure-helpers.ts` (specifically the `generateDirectoryTree` function).
- **Supporting file (for constant usage):** `src/core/analysis/constants.ts` (to import `SKIP_DIRECTORIES`).

## 4. Detailed Requirements

### Functional Requirements

1.  The `StructureHelpers.generateDirectoryTree` function must be modified to prevent recursion into, and exclude from the generated tree, any directory whose name is present in the `SKIP_DIRECTORIES` set.
2.  The `StructureHelpers.generateDirectoryTree` function must be modified to prevent recursion into, and exclude from the generated tree, any directory whose name starts with a dot (`.`) (e.g., `.git`, `.vscode`, `.idea`), unless explicitly allowed by a future configuration (currently, all hidden directories should be skipped).
3.  The `SKIP_DIRECTORIES` constant from `src/core/analysis/constants.ts` must be utilized for this check.
4.  The existing file-level filtering performed by the `shouldAnalyzeFile` callback within `generateDirectoryTree` must remain functional.
5.  The existing logic for pruning directory nodes that become empty (i.e., have no analyzable children files or subdirectories meeting inclusion criteria) must remain functional.

### Technical Requirements

1.  Import `SKIP_DIRECTORIES` from `src/core/analysis/constants.ts` into `src/core/analysis/structure-helpers.ts`.
2.  Within the `generateDirectoryTree` function, before processing a directory item and before making a recursive call, check if:
    a. The directory item's name is in `SKIP_DIRECTORIES`.
    b. The directory item's name starts with `.`.
3.  If either condition is true, the directory item should be skipped (not included in the `nodes` array and no recursive call made for it).
4.  Ensure changes are compatible with existing type definitions for `DirectoryNode`.
5.  Add comprehensive unit tests for `generateDirectoryTree` to specifically verify the new exclusion logic.

## 5. Acceptance Criteria Checklist

- **AC1 (SKIP_DIRECTORIES Integration):** The `generateDirectoryTree` function in `src/core/analysis/structure-helpers.ts` is modified to import and use the `SKIP_DIRECTORIES` set from `src/core/analysis/constants.ts`. It checks if a directory's name is in this set and skips it if true.
  - _Verification:_ Code review.
- **AC2 (Hidden Directory Exclusion):** The `generateDirectoryTree` function is modified to check if a directory's name starts with a dot (`.`). If true, the directory is skipped.
  - _Verification:_ Code review.
- **AC3 (Correct Exclusion in ProjectContext - SKIP_DIRECTORIES):** When `ProjectAnalyzer.analyzeProject` is run on the `roocode-generator` project (or a suitable test project), the `ProjectContext.structure.directoryTree` output does NOT contain entries for `node_modules`, `dist`, `coverage`, or `bin`.
  - _Verification:_ Manual inspection of logged `ProjectContext` or output from a test harness.
- **AC4 (Correct Exclusion in ProjectContext - Hidden Dirs):** When `ProjectAnalyzer.analyzeProject` is run, the `ProjectContext.structure.directoryTree` output does NOT contain entries for hidden directories like `.git`, `.vscode`, `.idea`.
  - _Verification:_ Manual inspection of logged `ProjectContext` or output from a test harness.
- **AC5 (Preservation of Valid Content):** The `ProjectContext.structure.directoryTree` continues to correctly include valid project directories and analyzable files that are not subject to exclusion.
  - _Verification:_ Manual inspection of logged `ProjectContext` or output from a test harness, comparing against a known project structure.
- **AC6 (Unit Tests):** New unit tests are added for the `generateDirectoryTree` function in `structure-helpers.ts`. These tests specifically cover:
  - Exclusion of directories listed in `SKIP_DIRECTORIES`.
  - Exclusion of hidden directories (starting with `.`).
  - Correct inclusion of valid directories and files.
  - Behavior with nested excluded/included directories.
  - _Verification:_ Code review of test cases and test execution results.
- **AC7 (No Regressions):** The existing functionality of `shouldAnalyzeFile` for filtering files and the pruning of empty directory branches remain unaffected and functional.
  - _Verification:_ Existing tests (if any) for these aspects should still pass. Manual inspection of `directoryTree` for complex cases.

## 6. Implementation Guidance

- In `src/core/analysis/structure-helpers.ts`, import `SKIP_DIRECTORIES` from `../constants`.
- Inside the `for (const item of items)` loop in `generateDirectoryTree`, before the `if (item.isDirectory())` block, add checks for `SKIP_DIRECTORIES.has(item.name)` and `item.name.startsWith('.')`. If either is true, `continue` to the next item.

## 7. File and Component References

- `src/core/analysis/structure-helpers.ts` (main file for modification)
- `src/core/analysis/constants.ts` (source of `SKIP_DIRECTORIES`)
- `src/core/analysis/project-analyzer.ts` (caller of `generateDirectoryTree`, for context)
- `task-tracking/TSK-017-FixGoogleGenAIProviderIssues/implementation-plan.md` (for context on where the issue was found)

## 8. Potential Risks

- Incorrectly implementing the check might lead to over-exclusion (missing valid directories) or continued under-exclusion. Thorough testing with varied project structures is important.
- Performance impact on very large directory structures, though the checks themselves are efficient.
