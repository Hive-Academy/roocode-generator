# Task: Revamp Roo Generator for Mode-Aware System Prompts

## Task Overview

Revamp the existing 'roo' generator within `AiMagicGenerator` to dynamically generate system prompt files for each RooCode mode. The generated files, located in the `.roo` folder, should combine the core `roo-rules.md`, the specific mode's system prompt template, and a minimum of 100 context-aware rules generated by the LLM based on the project context and the mode.

## Current Implementation Analysis

The existing `AiMagicGenerator` (`src/generators/ai-magic-generator.ts`) handles different generator types via a switch statement. The `generateRooContent` method currently builds prompts, calls the LLM, processes the output, and writes a single `generated-roo.md` file in the `.roo` folder. The prompt building logic in `buildRooPrompts` hardcodes the system prompt slug to 'code' and uses a generic user prompt, limiting its mode-awareness and dynamic content generation capabilities.

The `SystemPromptsGenerator` (`src/generators/system-prompts-generator.ts`) iterates through a hardcoded list of system prompt templates and writes them to the project root, but does not include `roo-rules.md` or context-aware rules.

The task requires combining and adapting the logic from both generators to achieve the desired mode-aware, context-rich system prompt generation in the `.roo` folder.

## Component Structure

The primary component to be modified is the `AiMagicGenerator` class in `src/generators/ai-magic-generator.ts`. The logic for iterating through modes, reading templates, building prompts, calling the LLM, and writing files will reside within the existing 'roo' case of this generator.

## Detailed Requirements

1.  Modify the existing 'roo' case within the `executeGeneration` method of `AiMagicGenerator` to implement the revamped logic.
2.  Implement logic within the 'roo' generator to:
    *   Read the directory `templates/system-prompts` to identify available system prompt files.
    *   Filter for files matching the pattern `system-prompt-*.md`, excluding `roo-rules.md`.
    *   For each identified `system-prompt-[mode].md` file:
        *   Read the content of `templates/system-prompts/roo-rules.md`.
        *   Read the content of the current `templates/system-prompts/system-prompt-[mode].md` file.
        *   Utilize the existing `projectContext` (obtained from `analyzeProject`) and the combined content of `roo-rules.md` and the specific `system-prompt-[mode].md` file to build a comprehensive prompt for the LLM. The prompt should clearly instruct the LLM to generate at least 100 context-aware rules relevant to the specific mode and the provided project context.
        *   Call the LLM agent (`llmAgent.getCompletion`) with the constructed prompt.
        *   Process the LLM's response (e.g., strip markdown code blocks using `contentProcessor.stripMarkdownCodeBlock`).
        *   Construct the final output content for the `.roo` file by concatenating:
            *   The exact content of `templates/system-prompts/roo-rules.md`.
            *   The exact content of the current `templates/system-prompts/system-prompt-[mode].md` file.
            *   The processed LLM-generated rules.
        *   Write the final content to a new file in the `.roo` folder with no file extension. The filename should follow the pattern `.roo/system-prompt-[mode-name]`, where `[mode-name]` is extracted from the original template filename (e.g., 'architect' from 'system-prompt-architect.md').
3.  Ensure the generated rules are context-aware, meaning they are relevant to the specific project's codebase, structure, and technologies (as captured in `projectContext`), and tailored to the responsibilities and workflow of the specific mode (as defined in the `system-prompt-[mode].md` file).
4.  Verify that the LLM-generated rules section in each output file contains a minimum of 100 distinct rules.
5.  Ensure the existing 'memory-bank' and 'cursor' generator types within `AiMagicGenerator` remain functional after the changes.
6.  Adhere to existing coding standards, architectural patterns, and dependency injection practices observed in `src/generators/ai-magic-generator.ts` and other relevant parts of the codebase.

## Acceptance Criteria Checklist

- [ ] AC1: Executing the 'roo' generator with the appropriate options triggers the revamped logic.
- [ ] AC2: The 'roo' generator successfully iterates through all files matching `system-prompt-*.md` in `templates/system-prompts`, excluding `roo-rules.md`.
- [ ] AC3: For each identified `system-prompt-[mode].md` file, a corresponding file named `.roo/system-prompt-[mode-name]` (with no extension) is created.
- [ ] AC4: Each generated file `.roo/system-prompt-[mode-name]` starts with the exact content of `templates/system-prompts/roo-rules.md`.
- [ ] AC5: Immediately following the `roo-rules.md` content, each generated file contains the exact content of its corresponding `templates/system-prompts/system-prompt-[mode].md` file.
- [ ] AC6: Following the system prompt content, each generated file contains a section with rules generated by the LLM.
- [ ] AC7: The LLM-generated rules section in each `.roo/system-prompt-[mode-name]` file contains at least 100 distinct rules.
- [ ] AC8: The generated rules are relevant to the project context (based on `projectContext`) and the specific mode (based on the `system-prompt-[mode].md` content).
- [ ] AC9: The implementation code adheres to the project's coding standards and architectural patterns.
- [ ] AC10: The existing 'memory-bank' and 'cursor' generator types in `AiMagicGenerator` remain functional.

## Implementation Guidance

- Analyze the existing `generateRooContent` and `buildRooPrompts` methods in `src/generators/ai-magic-generator.ts`.
- Analyze the file reading and iteration logic in `src/generators/system-prompts-generator.ts`.
- Modify the existing `generateRooContent` method or create a new private method called by it to handle the revamped roo generation logic.
- Use the `IFileOperations` service (`this.fileOps`) to read directory contents and file contents.
- Use the `IRulesPromptBuilder` or similar logic to construct the LLM prompt, incorporating `roo-rules.md`, the system prompt content, and the `projectContext`. Ensure the prompt clearly asks for at least 100 context-aware rules.
- Use the `LLMAgent` (`this.llmAgent`) to get the completion from the LLM.
- Use the `IContentProcessor` (`this.contentProcessor`) to process the LLM output, specifically `stripMarkdownCodeBlock`.
- Use `this.fileOps.writeFile` to write the final content to the `.roo` directory, ensuring no file extension is used in the output path.
- Ensure proper error handling and logging throughout the process.
- Pay close attention to extracting the mode slug from the system prompt filenames (e.g., 'architect' from 'system-prompt-architect.md') to use in the output filename.

## File and Component References

- `src/generators/ai-magic-generator.ts`: Primary file to modify.
- `templates/system-prompts/`: Directory containing source system prompt templates.
- `templates/system-prompts/roo-rules.md`: File containing core rules to include.
- `src/generators/system-prompts-generator.ts`: Contains relevant file reading/writing logic that can be adapted.
- `.roo/`: Target directory for generated files.

## Timeline Expectations

[To be determined by Architect during planning]

## Task Dependencies

None identified at this stage.
