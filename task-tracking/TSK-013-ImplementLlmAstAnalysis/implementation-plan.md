---
title: Implementation Plan
type: template
category: implementation
status: active
taskId: TSK-013
---

# Implementation Plan: TSK-013/ImplementLlmAstAnalysis

## 1. Overview

This plan outlines the steps to implement **TSK-013: Implement LLM Analysis of AST Data**. The goal is to enhance the `ProjectAnalyzer` by introducing a new service, `AstAnalysisService`, which uses an LLM to analyze the generic Abstract Syntax Tree (`astData`) generated in TSK-008. This analysis will extract structured code insights (functions, classes, imports) and store them in the `ProjectContext`.

The implementation will follow the recommendations from the research report included in the task description, specifically starting with "Approach 1: Direct LLM Call per File".

See [[task-tracking/TSK-013-ImplementLlmAstAnalysis/task-description.md]] for detailed requirements and the full research report.

## 2. Implementation Strategy

### 2.1. Approach

1.  **New Service (`AstAnalysisService`):** Create a dedicated service responsible for:
    - Accepting `astData` (`GenericAstNode`).
    - Constructing a detailed prompt including task description, `astData` structure explanation, the target `CodeInsights` JSON schema (defined via TypeScript interface), and few-shot examples.
    - Calling the `LLMAgent` to get LLM completion.
    - Validating the LLM response is valid JSON and conforms to the `CodeInsights` schema using the `zod` library.
    - Returning the validated `CodeInsights` or an error using the `Result` pattern.
2.  **Interface Definitions:** Define new interfaces (`IAstAnalysisService`, `CodeInsights`, `FunctionInfo`, `ClassInfo`, `ImportInfo`) in a dedicated file (`ast-analysis.interfaces.ts`).
3.  **`ProjectContext` Update:** Add a `codeInsights?: { [filePath: string]: CodeInsights }` field to the `ProjectContext` interface (`types.ts`).
4.  **`ProjectAnalyzer` Integration:**
    - Inject `IAstAnalysisService`.
    - After generating `astData` for each file, call `astAnalysisService.analyzeAst(astData)` concurrently using `Promise.all`.
    - Handle the `Result`: If `ok`, merge insights into `projectContext.codeInsights`. If `err`, log a warning using `ILogger` and continue analysis for other files.
5.  **Dependency Management:** Add `zod` as a project dependency.
6.  **DI Registration:** Register `AstAnalysisService` in the appropriate DI module (e.g., `core-module.ts` or a new `analysis-module.ts`).

### 2.2. Key Components

- **Create:**
  - `src/core/analysis/ast-analysis.service.ts`
  - `src/core/analysis/ast-analysis.interfaces.ts`
  - Unit tests for `AstAnalysisService` (e.g., `tests/core/analysis/ast-analysis.service.test.ts`)
  - Integration tests for `ProjectAnalyzer` analysis integration (e.g., `tests/core/analysis/project-analyzer.ast-analysis.test.ts`)
- **Modify:**
  - `src/core/analysis/project-analyzer.ts`
  - `src/core/analysis/types.ts`
  - `src/core/di/modules/core-module.ts` (or new analysis module)
  - `package.json` / `package-lock.json` (to add `zod`)
  - Existing `ProjectAnalyzer` tests (`tests/core/analysis/project-analyzer.test.ts`, `tests/core/analysis/project-analyzer.treesitter.test.ts`)
- **Use:**
  - `src/core/llm/llm-agent.ts` (`LLMAgent`)
  - `src/core/result/result.ts` (`Result`)
  - `src/core/services/logger-service.ts` (`ILogger`)
  - `zod` library

### 2.3. Dependencies

- Internal: `LLMAgent`, `ILogger`, `Result`, `GenericAstNode`, `ProjectContext`.
- External: `zod` (new).

### 2.4. Risk Areas

- **Prompt Engineering:** Crafting an effective prompt that consistently extracts the desired structure from varied `astData` is critical and may require iteration.
- **LLM Reliability/Variability:** LLM responses might be inconsistent, fail validation, or contain hallucinations. Robust validation (`zod`) and error handling (`Result`, logging in `ProjectAnalyzer`) are essential.
- **`astData` Size:** While starting with direct calls, large files might generate `astData` exceeding LLM context windows. Token counting and monitoring will be needed, potentially requiring future implementation of chunking (Approach 2).
- **Input `astData` Quality:** Relies on the `astData` generated by `TreeSitterParserService` (TSK-008). Existing deferred test debt for TSK-008 means input quality might vary.
- **Performance:** Concurrent LLM calls help, but analyzing many files can still be time-consuming. Batching (if supported) could be a future optimization.

## 3. Acceptance Criteria Mapping

- **AC1 (Service Created):** Covered by Subtask 1 & 2.
- **AC2 (Context Updated):** Covered by Subtask 1.
- **AC3 (Integration):** Covered by Subtask 3.
- **AC4 (Concurrency):** Covered by Subtask 3.
- **AC5 (LLM Interaction):** Covered by Subtask 2.
- **AC6 (Prompt Definition):** Covered by Subtask 2.
- **AC7 (Structured Output):** Covered by Subtask 1 (interface definition) & Subtask 2 (prompting/validation).
- **AC8 (Validation):** Covered by Subtask 2 (implementing `zod`).
- **AC9 (Error Handling):** Covered by Subtask 2 (`Result` return) & Subtask 3 (handling `Result`).
- **AC10 (Basic Functionality):** Verified via testing (Subtask 4/5).
- **AC11 (No New Config):** Ensured by design (uses existing LLM config).
- **AC12 (Documentation):** Covered by all implementation subtasks (TSDoc).

## 4. Implementation Subtasks

### Subtask 1: Define Interfaces & Update Context

**Status**: Completed

**Description**: Define the necessary interfaces for the AST analysis feature and update the `ProjectContext` to accommodate the results. Add `zod` dependency.

**Files to Modify**:

- `src/core/analysis/ast-analysis.interfaces.ts` (Create): Define `IAstAnalysisService`, `CodeInsights`, `FunctionInfo`, `ClassInfo`, `ImportInfo`.
- `src/core/analysis/types.ts` (Modify): Add `codeInsights?: { [filePath: string]: CodeInsights };` to `ProjectContext`.
- `package.json`, `package-lock.json` (Modify): Add `zod` dependency.

**Implementation Details**:

```typescript
// src/core/analysis/ast-analysis.interfaces.ts
import { Result } from '../result/result';
import { GenericAstNode } from './types';

export interface FunctionInfo {
  name: string;
  parameters: string[];
  // Optional: startLine?: number; endLine?: number;
}

export interface ClassInfo {
  name: string;
  // Optional: methods?: FunctionInfo[]; properties?: string[]; startLine?: number; endLine?: number;
}

export interface ImportInfo {
  source: string; // The path/module being imported (e.g., 'react', './utils')
  // Optional: importedSymbols?: string[]; isDefault?: boolean;
}

export interface CodeInsights {
  functions: FunctionInfo[];
  classes: ClassInfo[];
  imports: ImportInfo[];
  // Potentially add other insights later: variables, exports, etc.
}

export interface IAstAnalysisService {
  analyzeAst(astData: GenericAstNode, filePath: string): Promise<Result<CodeInsights, Error>>;
}

// Add TSDoc comments to all interfaces and members.
```

**Testing Requirements**:

- N/A for this subtask (interfaces only). Dependency installation verified by `npm install`.

**Related Acceptance Criteria**:

- AC2: `ProjectContext` updated.
- AC7: Structure for output defined.

**Estimated effort**: 15 minutes

**Required Delegation Components**:

- Implementation components for Junior Coder:
  - Define `FunctionInfo`, `ClassInfo`, `ImportInfo`, `CodeInsights` interfaces based on the structure above.
- Testing components for Junior Tester: N/A

**Delegation Success Criteria**:

- Junior Coder components must: Interfaces correctly defined with TSDoc comments in the specified file. `ProjectContext` updated correctly with TSDoc.

**Completion Notes**:

- `zod` dependency installed successfully via `npm install zod --save-exact`.
- Interface creation (`ast-analysis.interfaces.ts`) and `ProjectContext` update (`types.ts`) were delegated to Junior Coder.
- Junior Coder confirmed completion and adherence to specifications, including TSDoc comments.

**Acceptance Criteria Verification**:

- AC2: `ProjectContext` updated.
  - ✅ Satisfied by: Junior Coder added `codeInsights?: { [filePath: string]: CodeInsights };` with TSDoc to `ProjectContext` in `src/core/analysis/types.ts`.
  - Evidence: Junior Coder completion report confirmed the change.
- AC7: Structure for output defined.
  - ✅ Satisfied by: Junior Coder defined `CodeInsights`, `FunctionInfo`, `ClassInfo`, `ImportInfo` interfaces with TSDoc in `src/core/analysis/ast-analysis.interfaces.ts`.
  - Evidence: Junior Coder completion report confirmed the creation and content of the file.
- AC12: TSDoc comments added.
  - ✅ Satisfied by: Junior Coder included TSDoc comments for all new interfaces, members, and the updated `ProjectContext` field as per requirements.
  - Evidence: Junior Coder completion report confirmed the presence of TSDoc.

---

### Subtask 2: Implement `AstAnalysisService` Core Logic

**Status**: Completed

**Description**: Implement the core logic of `AstAnalysisService`, including prompt construction, LLM interaction via `LLMAgent`, and response validation using `zod`.

**Files to Modify**:

- `src/core/analysis/ast-analysis.service.ts` (Create): Implement the `analyzeAst` method.

**Implementation Details**:

1.  **Constructor:** Inject `LLMAgent` and `ILogger`.
2.  **`analyzeAst` Method:**
    - Receive `astData: GenericAstNode` and `filePath: string`.
    - **Prompt Construction:**
      - Create a detailed system prompt string. Include:
        - Clear task instruction (analyze `astData` JSON for functions, classes, imports).
        - Description of the `GenericAstNode` structure (type, text, children, etc.).
        - The target `CodeInsights` TypeScript interface definition (copied from `ast-analysis.interfaces.ts`).
        - Instruction to return ONLY valid JSON matching the interface.
        - At least one few-shot example: Show a simplified `astData` JSON snippet and the corresponding `CodeInsights` JSON output.
    - **LLM Call:**
      - Use `JSON.stringify(astData)` as the user prompt content.
      - Call `this.llmAgent.getCompletion(systemPrompt, astDataJsonString)`.
      - Handle potential errors from `getCompletion` (return `Result.err`).
    - **Validation:**
      - Define a `zod` schema corresponding exactly to the `CodeInsights` interface.
      - Try parsing the LLM response string using `JSON.parse()`. Catch parsing errors and return `Result.err`.
      - Use the `zodSchema.safeParse(parsedJson)` method to validate the parsed object against the schema.
      - If `safeParse` fails, log the validation errors (`result.error.issues`) and return `Result.err` with a descriptive error message.
    - **Return:** If validation succeeds, return `Result.ok(validatedData)`.

````typescript
// src/core/analysis/ast-analysis.service.ts (Conceptual)
import { Injectable, Inject } from '../di/decorators';
import {
  IAstAnalysisService,
  CodeInsights,
  FunctionInfo,
  ClassInfo,
  ImportInfo,
} from './ast-analysis.interfaces';
import { GenericAstNode } from './types';
import { Result } from '../result/result';
import { ILLMAgent } from '../llm/interfaces';
import { ILogger } from '../services/logger-service';
import { z, ZodType } from 'zod';
import { RooCodeError } from '../errors'; // Or a more specific error type

// Define Zod schema matching CodeInsights
const functionInfoSchema = z.object({
  name: z.string(),
  parameters: z.array(z.string()),
});

const classInfoSchema = z.object({
  name: z.string(),
});

const importInfoSchema = z.object({
  source: z.string(),
});

const codeInsightsSchema: ZodType<CodeInsights> = z.object({
  functions: z.array(functionInfoSchema),
  classes: z.array(classInfoSchema),
  imports: z.array(importInfoSchema),
});

@Injectable()
export class AstAnalysisService implements IAstAnalysisService {
  constructor(
    @Inject('LLMAgent') private readonly llmAgent: ILLMAgent,
    @Inject('ILogger') private readonly logger: ILogger
  ) {}

  async analyzeAst(
    astData: GenericAstNode,
    filePath: string
  ): Promise<Result<CodeInsights, Error>> {
    this.logger.debug(`Analyzing AST for file: ${filePath}`);

    const systemPrompt = this.buildPrompt(); // Define this method
    const astDataJsonString = JSON.stringify(astData); // Consider potential size issues later

    // Optional: Add token counting check here if needed later
    // const tokenCount = await this.llmAgent.countTokens(systemPrompt + astDataJsonString);
    // if (tokenCount > MAX_TOKENS) return Result.err(...)

    const completionResult = await this.llmAgent.getCompletion(systemPrompt, astDataJsonString);

    if (completionResult.isErr()) {
      this.logger.error(`LLM call failed for ${filePath}: ${completionResult.error.message}`);
      return Result.err(completionResult.error);
    }

    const rawResponse = completionResult.value;
    let parsedJson: unknown;

    try {
      // Clean potential markdown fences
      const cleanedResponse = rawResponse.replace(/```json\n?([\s\S]*?)\n?```/g, '$1').trim();
      parsedJson = JSON.parse(cleanedResponse);
    } catch (parseError) {
      this.logger.warn(
        `Failed to parse LLM JSON response for ${filePath}: ${parseError instanceof Error ? parseError.message : String(parseError)}`
      );
      this.logger.debug(`Raw response for ${filePath}:\n${rawResponse}`);
      return Result.err(
        new RooCodeError(`Invalid JSON response from LLM for ${filePath}`, { cause: parseError })
      );
    }

    const validationResult = codeInsightsSchema.safeParse(parsedJson);

    if (!validationResult.success) {
      this.logger.warn(
        `LLM response validation failed for ${filePath}: ${validationResult.error.message}`
      );
      this.logger.debug(`Validation issues: ${JSON.stringify(validationResult.error.issues)}`);
      this.logger.debug(`Parsed JSON for ${filePath}:\n${JSON.stringify(parsedJson, null, 2)}`);
      return Result.err(
        new RooCodeError(`LLM response failed schema validation for ${filePath}`, {
          cause: validationResult.error,
        })
      );
    }

    this.logger.debug(`Successfully analyzed and validated AST insights for ${filePath}`);
    return Result.ok(validationResult.data);
  }

  private buildPrompt(): string {
    // Construct the detailed prompt with instructions, schema, and few-shot example here.
    // Reference task description Section 2, Prompt Engineering.
    const prompt = `
### Instruction ###
Analyze the provided JSON AST ('astData') representing a source code file. Extract all top-level function definitions, class definitions, and import statements.
The 'astData' has nodes with a 'type' property (e.g., 'function_definition', 'class_definition', 'import_statement', 'identifier', 'formal_parameters', 'string_literal') and a 'children' array.
- Function names are typically in an 'identifier' node within 'function_definition'.
- Parameters are within 'formal_parameters' -> 'parameter_declaration' -> 'identifier'.
- Class names are typically in an 'identifier' node within 'class_definition'.
- Import sources are typically in a 'string_literal' or similar node within 'import_statement'.

Return the results ONLY as a valid JSON object matching the following TypeScript interface. Do NOT include any other text, explanations, or markdown formatting.

\`\`\`typescript
interface FunctionInfo {
  name: string;
  parameters: string[];
}

interface ClassInfo {
  name: string;
}

interface ImportInfo {
  source: string;
}

interface CodeInsights {
  functions: FunctionInfo[];
  classes: ClassInfo[];
  imports: ImportInfo[];
}
\`\`\`

### Example Input ('astData' Snippet) ###

\`\`\`json
{
  "type": "program",
  "children": [
    {
      "type": "import_statement",
      "children": [
        { "type": "import_clause", "children": [...] },
        { "type": "string_literal", "text": "'react'" }
      ]
    },
    {
      "type": "function_definition",
      "children": [
        { "type": "identifier", "text": "calculateTotal" },
        {
          "type": "formal_parameters",
          "children": [
            { "type": "parameter_declaration", "children": [{ "type": "identifier", "text": "price" }] },
            { "type": "parameter_declaration", "children": [{ "type": "identifier", "text": "quantity" }] }
          ]
        },
        { "type": "block", "children": [] }
      ]
    },
    {
      "type": "class_definition",
      "children": [
        { "type": "identifier", "text": "Product" },
        { "type": "class_body", "children": [] }
      ]
    }
  ]
}
\`\`\`

### Example Output (JSON only) ###

\`\`\`json
{
  "functions": [{ "name": "calculateTotal", "parameters": ["price", "quantity"] }],
  "classes": [{ "name": "Product" }],
  "imports": [{ "source": "react" }]
}
\`\`\`

### Input 'astData' ###

\`\`\`json
{{AST_DATA_JSON}}
\`\`\`

### Output (JSON only) ###

\`\`\`json

`;
    // Replace placeholder in the actual call
    return prompt.replace('{{AST_DATA_JSON}}', ''); // Base prompt structure
  }
}
````

**Testing Requirements**:

- Unit tests for `AstAnalysisService`:
  - Mock `LLMAgent.getCompletion`.
  - Test successful path: valid JSON response matching schema -> `Result.ok(CodeInsights)`.
  - Test failure paths:
    - `LLMAgent` returns error -> `Result.err`.
    - LLM returns invalid JSON -> `Result.err`.
    - LLM returns valid JSON but fails `zod` schema validation -> `Result.err`.
  - Verify prompt construction (partially, e.g., check for key sections).
  - Verify logger calls on success/failure.

**Related Acceptance Criteria**:

- AC1: Service implemented.
- AC5: Uses `LLMAgent`.
- AC6: Prompt defined.
- AC7: Attempts extraction.
- AC8: Validation implemented.
- AC9: Returns `Result`.
- AC12: TSDoc added.

**Estimated effort**: 30-45 minutes

**Required Delegation Components**:

- Implementation components for Junior Coder:
  - Implement the `zod` schema (`codeInsightsSchema` and sub-schemas).
  - Implement the `buildPrompt` method based on the provided structure and task description examples.
- Testing components for Junior Tester:
  - Implement unit tests covering success and failure paths described above.

**Delegation Success Criteria**:

- Junior Coder components: ✅ Completed. Zod schemas (`codeInsightsSchema` etc.) correctly implemented in `ast-analysis.service.ts` and reviewed. `buildPrompt` method correctly implemented in `ast-analysis.service.ts` and reviewed.
- Junior Tester components: ✅ Completed (after 1 redelegation). Unit tests in `ast-analysis.service.test.ts` cover all specified scenarios, use mocks correctly, and verify outcomes/logging. Reviewed and approved.

**Completion Notes**:

- Created `src/core/analysis/ast-analysis.service.ts`.
- Implemented `AstAnalysisService` class conforming to `IAstAnalysisService`.
- Injected `ILLMAgent` and `ILogger` via constructor.
- Implemented `analyzeAst` method:
  - Calls `buildPrompt` (delegated to Junior Coder).
  - Stringifies `astData` and includes it in the system prompt.
  - Calls `llmAgent.getCompletion` with the combined prompt and an empty user prompt.
  - Handles `Result` from LLM call (logs error on failure).
  - Cleans potential markdown fences from the response.
  - Parses response string as JSON (logs warning on failure, returns `RooCodeError`).
  - Validates parsed JSON using `codeInsightsSchema` (delegated to Junior Coder).
  - Handles validation failure (logs warning/issues, returns `RooCodeError`).
  - Returns `Result.ok(validatedData)` on success.
  - Added TSDoc comments for the class and public method.
- Delegated Zod schema implementation (`codeInsightsSchema` etc.) to Junior Coder - Successful.
- Delegated `buildPrompt` method implementation to Junior Coder - Successful.
- Delegated unit test implementation (`tests/core/analysis/ast-analysis.service.test.ts`) to Junior Tester - Successful after 1 redelegation due to initial non-completion. Tests reviewed and verified.
- Corrected TypeScript errors related to `RooCodeError` constructor and logger calls during implementation.

**Acceptance Criteria Verification**:

- AC1: Service implemented.
  - ✅ Satisfied by: `AstAnalysisService` class created in `src/core/analysis/ast-analysis.service.ts`, implementing `IAstAnalysisService`.
  - Evidence: Code file `src/core/analysis/ast-analysis.service.ts`.
- AC5: Uses `LLMAgent`.
  - ✅ Satisfied by: `ILLMAgent` injected in constructor and `llmAgent.getCompletion` called within `analyzeAst`.
  - Evidence: Code inspection; Verified by unit test `should return Ok with CodeInsights...`.
- AC6: Prompt defined.
  - ✅ Satisfied by: `buildPrompt` method implemented (delegated to Junior Coder) and called by `analyzeAst`. System prompt includes instructions, schema, example, and input AST.
  - Evidence: Code inspection; Verified by unit test `should build a prompt containing key elements`.
- AC7: Attempts extraction.
  - ✅ Satisfied by: The prompt explicitly instructs the LLM to extract functions, classes, and imports based on the AST structure.
  - Evidence: `buildPrompt` method content.
- AC8: Validation implemented.
  - ✅ Satisfied by: `codeInsightsSchema` (delegated to Junior Coder) defined using Zod and `safeParse` used in `analyzeAst` to validate the parsed LLM response.
  - Evidence: Code inspection; Verified by unit tests `should return Ok...` and `should return Err... when LLM response fails schema validation`.
- AC9: Returns `Result`.
  - ✅ Satisfied by: `analyzeAst` method returns `Promise<Result<CodeInsights, Error>>`. `Result.ok` returned on success, `Result.err` with `RooCodeError` returned on failures (LLM, parse, validation, unexpected).
  - Evidence: Method signature and return statements; Verified by all unit tests checking `result.isOk()` or `result.isErr()`.
- AC12: TSDoc added.
  - ✅ Satisfied by: TSDoc comments added to `AstAnalysisService` class and `analyzeAst` method. Delegated components (`buildPrompt`, Zod schemas) also included TSDoc as verified during review.
  - Evidence: Code inspection of `src/core/analysis/ast-analysis.service.ts`.

---

### Subtask 3: Integrate `AstAnalysisService` into `ProjectAnalyzer`

**Status**: Completed

**Description**: Modify `ProjectAnalyzer` to use the new `AstAnalysisService` to analyze `astData` for each file concurrently and merge the results into `ProjectContext`.

**Files to Modify**:

- `src/core/analysis/project-analyzer.ts`
- `tests/core/analysis/project-analyzer.test.ts` (Update/Add)
- `tests/core/analysis/project-analyzer.treesitter.test.ts` (Update/Add)
- `tests/core/analysis/project-analyzer.ast-analysis.test.ts` (Create)

**Implementation Details**:

1.  **Constructor Injection:**
    - Inject `IAstAnalysisService` using the token `'IAstAnalysisService'`.
    - Store it as a private readonly member `astAnalysisService`.
2.  **Refactor `analyzeProject` Method:**
    - **AST Generation Loop:**
      - Inside the loop iterating through `allFiles.value`:
        - Keep the call to `this.treeSitterParserService.parseFile(absolutePath)`.
        - Instead of directly adding `astData` to a map, create an array `astGenerationPromises`.
        - For each file, push an object `{ relativePath, promise: parsePromise }` to this array.
    - **Resolve AST Promises:**
      - After the loop, use `await Promise.allSettled(astGenerationPromises.map(p => p.promise))`.
      - Create an empty array `validAstData: { relativePath: string; astData: GenericAstNode }[] = []`.
      - Iterate through the `allSettled` results:
        - If `result.status === 'fulfilled'` and `result.value.isOk()`:
          - Find the corresponding `relativePath` from the original `astGenerationPromises` array using the index.
          - Push `{ relativePath, astData: result.value.value }` to `validAstData`.
        - If `result.status === 'fulfilled'` and `result.value.isErr()`:
          - Log a warning using `this.logger.warn` including the `relativePath` and `result.value.error.message`.
        - If `result.status === 'rejected'`:
          - Log a warning using `this.logger.warn` including the `relativePath` and `result.reason`.
    - **Code Insights Analysis:**
      - Create an array `analysisPromises` by mapping over `validAstData`.
      - For each `{ relativePath, astData }`, push `this.astAnalysisService.analyzeAst(astData, relativePath)`.
      - Use `await Promise.allSettled(analysisPromises)`.
    - **Process Analysis Results:**
      - Create an empty map `codeInsightsMap: { [filePath: string]: CodeInsights } = {}`.
      - Iterate through the `analysisResults` from `Promise.allSettled`:
        - Get the corresponding `relativePath` from `validAstData` using the index.
        - If `result.status === 'fulfilled'`:
          - Check the inner `Result`: `const analysisResult = result.value;`
          - If `analysisResult.isOk()`:
            - Assign `codeInsightsMap[relativePath] = analysisResult.value;`
            - Log debug message: `this.logger.debug(\`Successfully generated code insights for \${relativePath}\`);`
          - If `analysisResult.isErr()`:
            - Log warning: `this.logger.warn(\`Failed to generate code insights for \${relativePath}: \${analysisResult.error.message}\`);`
        - If `result.status === 'rejected'`:
          - Log error: `this.logger.error(\`AST analysis promise rejected for \${relativePath}: \${result.reason}\`);`
    - **Update `ProjectContext` Assembly:**
      - Populate `astData` field: Create the map from `validAstData`. `const astDataMap = Object.fromEntries(validAstData.map(item => [item.relativePath, item.astData]));`
      - Assign `astData: astDataMap` to the context.
      - Add the new `codeInsights` field: `codeInsights: codeInsightsMap`.
3.  **TSDoc Updates:**
    - Update TSDoc for the constructor and `analyzeProject` method to reflect the changes and the new dependency/logic.

**Testing Requirements**:

- Update existing integration tests (`project-analyzer.test.ts`, `project-analyzer.treesitter.test.ts`) or add new ones.
- Mock `IAstAnalysisService` using `jest.fn()`.
- Verify `astAnalysisService.analyzeAst` is called correctly for each valid `astData`.
- Mock successful `analyzeAst` calls (returning `Result.ok(mockCodeInsights)`) and verify `codeInsightsMap` is populated correctly in the final `ProjectContext`.
- Mock failed `analyzeAst` calls (returning `Result.err(new Error(...))`) and verify warnings are logged via mocked `ILogger`.
- Mock rejected `analyzeAst` promises (`Promise.reject(...)`) and verify errors are logged via mocked `ILogger`.
- Verify the overall `analyzeProject` method still completes successfully even with individual analysis failures/rejections.
- Verify the `astData` map in the context only contains entries for successfully parsed files.

**Related Acceptance Criteria**:

- AC3: Integration logic implemented.
- AC4: Concurrency using `Promise.allSettled`.
- AC9: Error handling for analysis results.
- AC12: TSDoc added for modifications.

**Estimated effort**: 1 hour (including delegation setup and review)

**Required Delegation Components**:

- Implementation components for Junior Coder:
  - Refactor the AST generation loop to collect promises. (Note: Adapted to synchronous parsing)
  - Implement the `Promise.allSettled` logic for resolving AST promises and collecting `validAstData`, including logging warnings for failures/rejections. (Note: Adapted to synchronous parsing)
  - Implement the `Promise.allSettled` logic for calling `astAnalysisService.analyzeAst` concurrently.
  - Implement the processing of analysis results (checking status, inner `Result`, populating `codeInsightsMap`, logging debug/warning/error messages).
- Testing components for Junior Tester:
  - Update/create integration tests for `ProjectAnalyzer` as described in "Testing Requirements". Ensure mocks for `IAstAnalysisService` and `ILogger` are used correctly to verify interactions and logging in success, failure (`Result.err`), and rejection scenarios.

**Delegation Success Criteria**:

- Junior Coder components: ✅ Completed. Correctly implemented synchronous AST collection into `validAstData` with logging. Correctly implemented `Promise.allSettled` for analysis calls and result processing/logging. Included TSDoc. Reviewed and approved.
- Junior Tester components: ✅ Completed. Created new test file `project-analyzer.ast-analysis.test.ts`. Tests effectively mock dependencies (`IAstAnalysisService`, `ILogger`, `ITreeSitterParserService`) and verify interactions, context population (`codeInsights`, `astData`), and logging for success/failure/rejection scenarios. Reviewed and approved.

**Completion Notes**:

- Injected `IAstAnalysisService` into `ProjectAnalyzer` constructor.
- Updated `analyzeProject` TSDoc.
- Delegated core refactoring (AST collection, concurrent analysis, result processing) to Junior Coder. Junior Coder correctly adapted the plan for synchronous parsing and implemented the required logic.
- Delegated integration testing to Junior Tester. Junior Tester created a dedicated test file and verified all required scenarios, including error handling and context population.
- Applied changes to correctly assemble the final `ProjectContext`, using `validAstData` to create `astDataMap` and assigning `codeInsightsMap` to the `codeInsights` field.
- Reviewed and integrated all delegated work.

**Acceptance Criteria Verification**:

- AC3: Integration logic implemented.
  - ✅ Satisfied by: `IAstAnalysisService` injected; `analyzeProject` refactored to collect valid ASTs, call `analyzeAst` concurrently, process results, and populate `codeInsights` and `astData` in the final `ProjectContext`.
  - Evidence: Code in `src/core/analysis/project-analyzer.ts`; Junior Coder & Tester completion reports.
- AC4: Concurrency using `Promise.allSettled`.
  - ✅ Satisfied by: `Promise.allSettled` used to execute `astAnalysisService.analyzeAst` calls concurrently for all valid ASTs.
  - Evidence: Lines ~165-197 in `src/core/analysis/project-analyzer.ts`; Junior Coder completion report; Verified by Junior Tester's tests covering mixed success/failure scenarios.
- AC9: Error handling for analysis results.
  - ✅ Satisfied by: Logic correctly handles `Promise.allSettled` results ('fulfilled'/'rejected') and the inner `Result` (`isOk`/`isErr`) from `analyzeAst`. Appropriate logging (`debug`/`warn`/`error`) implemented for each case. Method completes successfully even with errors.
  - Evidence: Lines ~175-197 in `src/core/analysis/project-analyzer.ts`; Junior Coder completion report; Verified by Junior Tester's tests for `Result.err` and rejection scenarios.
- AC12: TSDoc added for modifications.
  - ✅ Satisfied by: TSDoc updated for `analyzeProject` method. Junior Coder added TSDoc for new logic blocks within the method.
  - Evidence: Code inspection of `src/core/analysis/project-analyzer.ts`.

---

### Subtask 4: Register `AstAnalysisService` in DI Container

**Status**: Not Started

**Description**: Register the new `AstAnalysisService` with the dependency injection container so it can be injected into `ProjectAnalyzer`.

**Files to Modify**:

- `src/core/di/modules/core-module.ts` (or potentially a new `analysis-module.ts` if preferred for organization)

**Implementation Details**:

1.  Import `AstAnalysisService` and `IAstAnalysisService`.
2.  In the `providers` array of the relevant module definition, add an entry:
    ```typescript
    { provide: 'IAstAnalysisService', useClass: AstAnalysisService },
    ```

**Testing Requirements**:

- DI container setup tests (if any exist) might implicitly cover this. Manual verification or a simple integration test ensuring `ProjectAnalyzer` can be resolved with its new dependency might be useful.

**Related Acceptance Criteria**:

- AC10: Basic functionality enabled by DI.

**Estimated effort**: 10 minutes

**Required Delegation Components**:

- Implementation components for Junior Coder: N/A (Simple configuration change)
- Testing components for Junior Tester: N/A

**Delegation Success Criteria**: N/A

**Completion Notes**:

- [ ] (To be filled upon completion)

**Acceptance Criteria Verification**:

- AC10: Basic functionality enabled by DI.
  - [ ] Satisfied by:
  - [ ] Evidence:

---

### Subtask 5: Final Review, Testing, and Documentation Polish

**Status**: Not Started

**Description**: Perform a final review of all changes, ensure all tests pass, polish TSDoc comments, and update the implementation plan with completion details.

**Files to Modify**:

- `task-tracking/TSK-013-ImplementLlmAstAnalysis/implementation-plan.md` (This file)
- Any files requiring TSDoc polishing.

**Implementation Details**:

1.  Run all unit and integration tests (`npm test`). Fix any failures.
2.  Review all modified files for code quality, adherence to patterns, and clarity.
3.  Review and polish all TSDoc comments added or modified during this task.
4.  Update the "Completion Notes" and "Acceptance Criteria Verification" sections for Subtasks 3 and 4 in this document.
5.  Mark Subtasks 3, 4, and 5 as "Completed".

**Testing Requirements**:

- All tests must pass (`npm test`).

**Related Acceptance Criteria**:

- All ACs verified through final checks and test runs.

**Estimated effort**: 20 minutes

**Required Delegation Components**: N/A

**Delegation Success Criteria**: N/A

**Completion Notes**:

- [ ] (To be filled upon completion)

**Acceptance Criteria Verification**:

- All ACs:
  - [ ] Satisfied by: Final review, passing tests, documentation updates.
  - [ ] Evidence: Test run results, final state of code and documentation.

---
