# Task Description: Refine AI Magic Generator Rules Output

## Task ID: TSK-021

## Task Name: RefineAIMagicRulesOutput

## Task Overview

Modify the AI Magic Generator's interaction with the LLM to ensure that when generating the list of rules, the LLM's response contains _only_ the list of rules themselves, without any introductory phrases (e.g., "Here are the rules:") or concluding remarks. The output should be a clean, parseable list of rules.

## Current Implementation Analysis

The AI Magic Generator (`src/generators/ai-magic-generator.ts`) utilizes the LLM integration layer (`src/core/llm/`) and likely a prompt builder (`src/generators/rules-prompt-builder.ts`) to generate rules based on project context. The current implementation may result in LLM responses that include conversational text surrounding the generated rule list.

Relevant files and components:

- [`src/generators/ai-magic-generator.ts`](src/generators/ai-magic-generator.ts)
- [`src/generators/rules-prompt-builder.ts`](src/generators/rules-prompt-builder.ts)
- [`src/core/llm/llm-agent.ts`](src/core/llm/llm-agent.ts)
- [`src/core/templating/rules-template-manager.ts`](src/core/templating/rules-template-manager.ts)
- Template files used for AI Magic rule generation (likely in `templates/`).

## Component Structure

The change will primarily affect the interaction between the `AiMagicGenerator`, the `RulesPromptBuilder`, and the `LLMAgent`. The prompt sent to the LLM needs to be carefully crafted to request _only_ the rule list, and the response parsing might need adjustments to handle potential variations, although the goal is to eliminate them.

## Detailed Requirements

1.  Modify the prompt construction logic (likely in `RulesPromptBuilder`) for the AI Magic Generator to explicitly instruct the LLM to output _only_ the list of rules in a specific, consistent format (e.g., a markdown list, JSON array, etc.) without any surrounding text.
2.  Ensure the `LLMAgent` is configured to request a response format that facilitates this (e.g., JSON mode if applicable, or clear instructions for markdown).
3.  Update the response parsing logic (if necessary) to robustly extract _only_ the rule list from the LLM's output, even if the LLM occasionally includes minimal surrounding text (though the primary goal is to prevent this).
4.  The generated output file for rules should contain only the extracted rule list.

## Acceptance Criteria Checklist

- [ ] **AC1**: The output generated by the AI Magic Generator for rules contains _only_ the list of rules.
  - **Verification Method**: Manually inspect the generated rule file.
  - **Evidence**: The generated file content contains only the rule list.
- [ ] **AC2**: The generated rule list is in a consistent and expected format (e.g., markdown list, JSON array).
  - **Verification Method**: Manually inspect the generated rule file.
  - **Evidence**: The format matches the intended structure.
- [ ] **AC3**: There are no introductory or concluding conversational phrases from the LLM in the generated rule file.
  - **Verification Method**: Manually inspect the generated rule file.
  - **Evidence**: Absence of phrases like "Here are the rules:", "Below is the list:", "I hope this helps.", etc.
- [ ] **AC4**: The change does not negatively impact the generation of other content types by the AI Magic Generator or other generators.
  - **Verification Method**: Run other generators and verify their output format.
  - **Evidence**: Other generated files maintain their correct format.

## Implementation Guidance

- Focus on refining the system prompt and user messages sent to the LLM via the `LLMAgent`.
- Consider using specific LLM features like JSON mode if the target LLM provider supports it and a JSON array format for rules is suitable.
- If relying on text-based output (like markdown), provide very clear negative constraints in the prompt (e.g., "DO NOT include any introductory or concluding sentences.").
- Update relevant unit tests for the `RulesPromptBuilder` and `AiMagicGenerator` to assert the format of the generated output.

## File and Component References

- [`src/generators/ai-magic-generator.ts`](src/generators/ai-magic-generator.ts)
- [`src/generators/rules-prompt-builder.ts`](src/generators/rules-prompt-builder.ts)
- [`src/core/llm/llm-agent.ts`](src/core/llm/llm-agent.ts)
- [`src/core/templating/rules-template-manager.ts`](src/core/templating/rules-template-manager.ts)
- Template files (e.g., `templates/ai-magic-rules.md` or similar).
