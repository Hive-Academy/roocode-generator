## Implementation Plan: Refine AI Magic Generator Rules Output (TSK-021)

### Overview

This plan outlines the technical steps to refine the output of the AI Magic Generator when generating rules. The primary goal is to eliminate conversational filler from the LLM response and ensure the output contains only the list of rules in a consistent, parseable format. This will involve modifying the prompt template used for rules generation and potentially adjusting the response processing logic. Additionally, legacy code within the relevant generator files will be identified and cleaned up, addressing specific points raised in the code review. Finally, critical issues identified in the re-review regarding the final output file content and system prompt composition will be addressed. Testing for this task is deferred to a later stage.

Key implementation decisions will revolve around the specific instructions added to the prompt to enforce the desired output format and the method for parsing the LLM's response.

Files likely to be modified:

- [`src/generators/ai-magic-generator.ts`](src/generators/ai-magic-generator.ts) (or related prompt building/processing files)
- [`src/core/templating/rules-prompt-builder.ts`](src/core/templating/rules-prompt-builder.ts) (or similar prompt building logic)
- Files within [`src/generators/rules`](src/generators/rules)

### Implementation Strategy

The high-level approach is to modify the prompt template used by the `AiMagicGenerator` specifically for rules generation. We will add explicit instructions to the LLM to output _only_ the list of rules in a predefined, structured format (e.g., a Markdown list or JSON array). The response processing logic will be reviewed to ensure it correctly handles this new format and can robustly extract the rules, ignoring any potential residual filler. We will rely on existing prompt building and template management services (`RulesPromptBuilder`, `TemplateManager`). Concurrently, we will identify and remove any legacy or unused code within the targeted generator files to improve clarity and maintainability, specifically addressing areas highlighted in the code review. The undocumented "100 rules" instruction will also be addressed. Finally, the logic for assembling the final output file will be corrected to contain _only_ the generated rules, and the system prompt composition will be simplified. Testing for this task is explicitly deferred.

Technical challenges include ensuring the LLM consistently adheres to the strict output format instructions and handling potential variations in the response despite the instructions. Identifying legacy code will require careful review of the current usage of classes and methods within the generator flow.

### Acceptance Criteria Mapping

- **The output generated by the AI Magic Generator for rules contains _only_ the list of rules.**
  - Satisfied by: Modifying the prompt to request only rules and adjusting response parsing to extract only the rule list. **Correcting final file output to contain only extracted rules.**
  - Verified through: Manual inspection of generated output.
- **The generated rule list is in a consistent and expected format (e.g., markdown list, JSON array).**
  - Satisfied by: Specifying the exact required format in the prompt instructions and validating the parsed output format.
  - Verified through: Manual inspection of generated output.
- **There are no introductory or concluding conversational phrases from the LLM in the generated rule file.**
  - Satisfied by: Explicitly instructing the LLM in the prompt to avoid conversational text and implementing robust parsing that discards such text.
  - Verified through: Manual inspection of generated output.
- **The change does not negatively impact the generation of other content types by the AI Magic Generator or other generators.**
  - Satisfied by: Ensuring changes are scoped specifically to rules generation prompts/processing and running existing integration tests for other generator types (if available and not deferred).
  - Verified through: Manual verification of other generator outputs (if applicable) and code review.

### Implementation Subtasks

#### 1. Analyze and Modify Rules Prompt Template

**Status**: Completed

**Description**: Examine the current prompt template or logic used by `AiMagicGenerator` for generating rules. Identify where instructions for the LLM are constructed. Modify the prompt to include clear, unambiguous instructions for the LLM to output _only_ the list of rules in a specific, parseable format (e.g., a Markdown unordered list). Explicitly instruct the LLM to avoid any introductory or concluding remarks.

**Files to Modify**:

- [`src/generators/ai-magic-generator.ts`](src/generators/ai-magic-generator.ts) - Identify prompt construction logic.
- [`src/core/templating/rules-prompt-builder.ts`](src/core/templating/rules-prompt-builder.ts) - Modify prompt building logic/template.

**Implementation Details**:

```typescript
// Example: Modify prompt template string or builder logic
const rulesPrompt = `
... existing prompt content ...

Please provide ONLY the list of rules as a Markdown unordered list. Do not include any introductory or concluding sentences.

- Rule 1: Description
- Rule 2: Description
...
`;
```

**Related Acceptance Criteria**:

- The output generated by the AI Magic Generator for rules contains _only_ the list of rules.
- The generated rule list is in a consistent and expected format (e.g., markdown list, JSON array).
- There are no introductory or concluding conversational phrases from the LLM in the generated rule file.

**Estimated effort**: 30-45 minutes

**Required Delegation Components**:

- Implementation components for Junior Coder:
  - None directly suitable for isolated delegation due to tight coupling with prompt building logic.
- Testing components for Junior Tester:
  - Testing is deferred for this task.

**Delegation Success Criteria**:

- Not applicable as testing is deferred.

**Delegation Decisions**:

- No components were delegated for this subtask due to the tight coupling of the prompt building logic and the small scope of changes required.
- Testing was deferred based on user preference.

**Redelegation History**: None

#### 2. Update Rules Response Processing

**Status**: Completed

**Description**: Examine the code in `AiMagicGenerator` (or related services) that processes the LLM's response for rules generation. Update this logic to robustly extract the rule list based on the specified format (e.g., parsing a Markdown list). Implement logic to discard any text before or after the expected list format. Add validation to ensure the extracted content matches the expected structure of a rule list.

**Files to Modify**:

- [`src/generators/ai-magic-generator.ts`](src/generators/ai-magic-generator.ts) - Modify response processing logic.
- [`src/core/llm/response-parser.ts`](src/core/llm/response-parser.ts) (or similar) - Potentially add/modify parsing logic.

**Implementation Details**:

```typescript
// Example: Parsing logic
function extractRulesFromResponse(response: string): string[] {
  // Implement parsing based on expected format (e.g., regex for markdown list items)
  const ruleMatches = response.match(/^- .+/gm);
  if (!ruleMatches) {
    // Handle cases where format is not matched, potentially log warning or throw error
    return [];
  }
  return ruleMatches.map((match) => match.substring(2).trim()); // Extract rule text
}
```

**Related Acceptance Criteria**:

- The output generated by the AI Magic Generator for rules contains _only_ the list of rules.
- The generated rule list is in a consistent and expected format (e.g., markdown list, JSON array).
- There are no introductory or concluding conversational phrases from the LLM in the generated rule file.

**Estimated effort**: 45-60 minutes

**Required Delegation Components**:

- Implementation components for Junior Coder:
  - **Markdown List Parser**: Implement a utility function or class method specifically for parsing a Markdown unordered list from a string, returning an array of list item strings. This component should be pure and testable in isolation.
- Testing components for Junior Tester:
  - Testing is deferred for this task.

**Delegation Success Criteria**:

- Junior Coder components must: Correctly parse Markdown unordered lists and return an array of strings, handling edge cases like empty input or no list items.
- Not applicable as testing is deferred.
- Integration requirements: The delegated parser component must be correctly integrated into the `AiMagicGenerator`'s response processing flow.

**Redelegation History**: None

#### 3. Identify and Clean Up Legacy Code (Initial Pass)

**Status**: Completed

**Description**: Review the code within the `src/generators/rules` directory and the `src/generators/ai-magic-generator.ts` file. Identify any code (classes, methods, variables, comments, stubs) that is no longer used or is related to previous iterations of the rules generation logic that are not part of the current or planned approach. Remove this legacy code to improve code clarity and maintainability.

**Files to Modify**:

- [`src/generators/rules/interfaces.ts`](src/generators/rules/interfaces.ts)
- [`src/generators/rules/rules-content-processor.ts`](src/generators/rules/rules-content-processor.ts)
- [`src/generators/rules/rules-file-manager.ts`](src/generators/rules/rules-file-manager.ts)
- [`src/generators/rules/rules-prompt-builder.ts`](src/generators/rules/rules-prompt-builder.ts)
- [`src/generators/ai-magic-generator.ts`](src/generators/ai-magic-generator.ts)

**Implementation Details**:

```typescript
// Example: Identify and remove unused methods or properties
// Review AiMagicGenerator for methods related to old roo generation logic
// Review RulesContentProcessor for stub implementations that are no longer needed
// Review interfaces for unused definitions
```

**Related Acceptance Criteria**:

- (Implicitly supports maintainability and clarity, which contributes to the overall quality and confidence in meeting other criteria).

**Estimated effort**: 30-45 minutes

**Required Delegation Components**:

- Implementation components for Junior Coder:
  - **Code Cleanup**: Review specific files (e.g., `rules-content-processor.ts`, `rules-prompt-builder.ts`) to identify and remove commented-out code, unused variables, or stub implementations based on guidance from the Senior Developer.
- Testing components for Junior Tester:
  - Testing is deferred for this task.

**Delegation Success Criteria**:

- Junior Coder components must: Successfully remove identified legacy code without introducing syntax errors or breaking existing, necessary functionality.
- Not applicable as testing is deferred.
- Integration requirements: The cleaned-up code should integrate seamlessly with the remaining codebase.

**Redelegation History**: None

#### 4. Address Code Review Feedback (Legacy Code & 100 Rules)

**Status**: Completed

**Description**: Address specific points raised in the Code Review:

1. Re-evaluate and potentially remove further legacy code identified by the reviewer, including `RulesFileManager`, the `processContent` method in `RulesContentProcessor`, and the unused `template` parameter in `IRulesPromptBuilder.buildPrompt`.
2. Remove or document the undocumented instruction for the LLM to generate "at least 100 rules" in `RulesPromptBuilder`. If the requirement for 100 rules is necessary, add it to the task description and implementation plan. If not, remove the instruction from the prompt.

**Files to Modify**:

- [`src/generators/rules/interfaces.ts`](src/generators/rules/interfaces.ts)
- [`src/generators/rules/rules-content-processor.ts`](src/generators/rules/rules-content-processor.ts)
- [`src/generators/rules/rules-file-manager.ts`](src/generators/rules/rules-file-manager.ts)
- [`src/generators/rules/rules-prompt-builder.ts`](src/generators/rules/rules-prompt-builder.ts)
- [`src/generators/ai-magic-generator.ts`](src/generators/ai-magic-generator.ts)
- [`task-tracking/TSK-021-RefineAIMagicRulesOutput/task-description.md`](task-tracking/TSK-021-RefineAIMagicRulesOutput/task-description.md) (if documenting 100 rules requirement)
- [`task-tracking/TSK-021-RefineAIMagicRulesOutput/implementation-plan.md`](task-tracking/TSK-021-RefineAIMagicRulesOutput/implementation-plan.md) (if documenting 100 rules requirement)

**Implementation Details**:

```typescript
// Example: Remove RulesFileManager if unused
// Example: Remove processContent if unused
// Example: Remove 'template' parameter from buildPrompt and interface
// Example: Remove or document 'Ensure there are at least 100 rules' instruction
```

**Related Acceptance Criteria**:

- (Implicitly supports maintainability, clarity, and adherence to documented requirements).

**Estimated effort**: 30-45 minutes

**Required Delegation Components**:

- Implementation components for Junior Coder:
  - **Specific Code Removal**: Remove specific identified legacy code elements (e.g., a class, a method, a parameter) based on clear instructions.
- Testing components for Junior Tester:
  - Testing is deferred for this task.

**Delegation Success Criteria**:

- Junior Coder components must: Successfully remove the specified code elements without introducing errors.
- Not applicable as testing is deferred.
- Integration requirements: The changes should integrate seamlessly.

**Redelegation History**: None

#### 5. Address Code Review Re-review Feedback (Final Output & Prompt Composition)

**Status**: Not Started

**Description**: Address the critical issues raised in the Code Review re-review:

1. Modify the logic in `AiMagicGenerator.generateRooContent` to ensure that the content written to the output rule files (`.roo/system-prompt-MODE_NAME`) is _only_ the `processedLLMRules` string, thereby satisfying Acceptance Criterion 1.
2. Re-evaluate and simplify the system prompt composition in `AiMagicGenerator.buildModeRooPrompt`. Remove the concatenation of `templates/system-prompts/roo-rules.md` and the mode-specific system prompt template if the system prompt from `RulesPromptBuilder` is sufficient on its own.

**Files to Modify**:

- [`src/generators/ai-magic-generator.ts`](src/generators/ai-magic-generator.ts)

**Implementation Details**:

```typescript
// Example: Modify finalContent assembly in generateRooContent
// const finalContent = processedLLMRules; // Should only be the rules

// Example: Simplify system prompt composition in buildModeRooPrompt
// const systemPrompt = this.rulesPromptBuilder.buildSystemPrompt(modeName).value; // Use builder directly
```

**Related Acceptance Criteria**:

- The output generated by the AI Magic Generator for rules contains _only_ the list of rules.
- (Implicitly supports code quality and LLM interaction effectiveness).

**Estimated effort**: 30-45 minutes

**Required Delegation Components**:

- Implementation components for Junior Coder:
  - **Specific Code Modification**: Modify the line assembling the `finalContent` in `generateRooContent` to only include the processed rules.
- Testing components for Junior Tester:
  - Testing is deferred for this task.

**Delegation Success Criteria**:

- Junior Coder components must: Successfully modify the specified line to correct the final output content.
- Not applicable as testing is deferred.
- Integration requirements: The change should integrate seamlessly.

**Redelegation History**: None

#### 6. Final Integration and Verification

**Status**: Not Started

**Description**: Integrate the changes from subtask 5. Ensure all previous changes and cleanup efforts are correctly applied and do not cause errors. Manually verify the output of the rules generator to confirm the absence of conversational filler and the correct format as per the acceptance criteria, paying close attention to the final file content to ensure only rules are present. Manually verify the output of other generators (if applicable) to confirm no unintended side effects.

**Files to Modify**:

- [`src/generators/ai-magic-generator.ts`](src/generators/ai-magic-generator.ts) - Integrate modified components.

**Implementation Details**:

```typescript
// Example: Integration points
async generateRules(...) {
  // Ensure updated prompt builder and response processor are used
  // Verify that removed legacy code does not cause errors
  // Verify final file content is correct
}
```

**Related Acceptance Criteria**:

- The output generated by the AI Magic Generator for rules contains _only_ the list of rules.
- The generated rule list is in a consistent and expected format (e.g., markdown list, JSON array).
- There are no introductory or concluding conversational phrases from the LLM in the generated rule file.
- The change does not negatively impact the generation of other content types by the AI Magic Generator or other generators.

**Estimated effort**: 30-45 minutes

**Required Delegation Components**:

- Implementation components for Junior Coder: None.
- Testing components for Junior Tester:
  - Testing is deferred for this task.

**Delegation Success Criteria**:

- Not applicable as testing is deferred.

**Redelegation History**: None

### Implementation Sequence

1. Analyze and Modify Rules Prompt Template - Focus on instructing the LLM clearly. (Completed)
2. Update Rules Response Processing - Build robust parsing logic based on the expected format. (Completed)
3. Identify and Clean Up Legacy Code (Initial Pass) - Remove unused code to improve maintainability. (Completed)
4. Address Code Review Feedback (Legacy Code & 100 Rules) - Address specific cleanup and documentation points from the review. (Completed)
5. Address Code Review Re-review Feedback (Final Output & Prompt Composition) - Address critical issues regarding final file content and system prompt.
6. Final Integration and Verification - Combine the changes and ensure everything works as expected without regressions.

### Testing Strategy

Testing for this task is deferred to a later stage. Manual verification of the generated output will be performed to confirm adherence to the acceptance criteria regarding output format and the absence of conversational filler. Manual verification of other generator outputs will also be performed to check for unintended side effects.
